FROM maven:3-amazoncorretto-21 AS dev
WORKDIR /app

RUN mkdir -p /root/.m2 && printf '%s\n' \
  '<settings>' \
  '  <servers>' \
  '    <server><id>github-nimbly-notification</id><username>${env.GH_ACTOR}</username><password>${env.GH_PACKAGES_TOKEN}</password></server>' \
  '    <server><id>github-nimbly-commons</id><username>${env.GH_ACTOR}</username><password>${env.GH_PACKAGES_TOKEN}</password></server>' \
  '    <server><id>github-nimbly-useraccounts</id><username>${env.GH_ACTOR}</username><password>${env.GH_PACKAGES_TOKEN}</password></server>' \
  '    <server><id>github-nimbly-alerts</id><username>${env.GH_ACTOR}</username><password>${env.GH_PACKAGES_TOKEN}</password></server>' \
  '  </servers>' \
  '</settings>' \
  > /root/.m2/settings.xml

COPY pom.xml .
COPY ph-shoes-alerts-service-core/pom.xml ph-shoes-alerts-service-core/pom.xml
COPY ph-shoes-alerts-service-web/pom.xml ph-shoes-alerts-service-web/pom.xml
COPY ph-shoes-alerts-service-scheduler/pom.xml ph-shoes-alerts-service-scheduler/pom.xml
COPY ph-shoes-alerts-service-core ./ph-shoes-alerts-service-core
COPY ph-shoes-alerts-service-web ./ph-shoes-alerts-service-web
COPY ph-shoes-alerts-service-scheduler ./ph-shoes-alerts-service-scheduler

EXPOSE 8084
CMD ["mvn","-pl","ph-shoes-alerts-service-web","-am","-U","-Pdev","spring-boot:run","-Dspring-boot.run.profiles=dev","-Dspring-boot.run.fork=false","-Dspring-boot.run.jvmArguments=${JAVA_TOOL_OPTIONS}"]
