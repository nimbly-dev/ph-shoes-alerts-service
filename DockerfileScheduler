## ---------- Build stage ----------
FROM maven:3-amazoncorretto-21 AS build
WORKDIR /workspace

ARG GH_ACTOR
ARG GH_PACKAGES_TOKEN
ARG MAVEN_ACTIVE_PROFILES=prod
ENV MAVEN_SETTINGS_PATH=/tmp/maven-settings.xml
ENV SPRING_PROFILES_ACTIVE=${MAVEN_ACTIVE_PROFILES}

RUN printf '%s\n' \
    '<settings>' \
    '  <servers>' \
    '    <server><id>github-nimbly-notification</id><username>'"${GH_ACTOR}"'</username><password>'"${GH_PACKAGES_TOKEN}"'</password></server>' \
    '    <server><id>github-nimbly-commons</id><username>'"${GH_ACTOR}"'</username><password>'"${GH_PACKAGES_TOKEN}"'</password></server>' \
    '    <server><id>github-nimbly-useraccounts</id><username>'"${GH_ACTOR}"'</username><password>'"${GH_PACKAGES_TOKEN}"'</password></server>' \
    '    <server><id>github-nimbly-alerts</id><username>'"${GH_ACTOR}"'</username><password>'"${GH_PACKAGES_TOKEN}"'</password></server>' \
    '  </servers>' \
    '</settings>' \
    > ${MAVEN_SETTINGS_PATH}

COPY pom.xml .
COPY ph-shoes-alerts-service-core/pom.xml ph-shoes-alerts-service-core/pom.xml
COPY ph-shoes-alerts-service-web/pom.xml ph-shoes-alerts-service-web/pom.xml
COPY ph-shoes-alerts-service-scheduler-web/pom.xml ph-shoes-alerts-service-scheduler-web/pom.xml
RUN --mount=type=cache,target=/root/.m2 mvn -s ${MAVEN_SETTINGS_PATH} -q -U -P${MAVEN_ACTIVE_PROFILES} dependency:go-offline

COPY ph-shoes-alerts-service-core ./ph-shoes-alerts-service-core
COPY ph-shoes-alerts-service-web ./ph-shoes-alerts-service-web
COPY ph-shoes-alerts-service-scheduler-web ./ph-shoes-alerts-service-scheduler-web
RUN --mount=type=cache,target=/root/.m2 mvn -s ${MAVEN_SETTINGS_PATH} -q -U -pl ph-shoes-alerts-service-scheduler-web -am -P${MAVEN_ACTIVE_PROFILES} package
RUN rm -f ${MAVEN_SETTINGS_PATH}

## ---------- Runtime stage ----------
FROM amazoncorretto:21-alpine AS runtime
ENV APP_HOME=/app \
    JAVA_TOOL_OPTIONS="-XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp -XX:MaxRAMPercentage=75" \
    SPRING_PROFILES_ACTIVE=prod \
    PORT=8085

RUN addgroup -S spring && adduser -S spring -G spring
RUN apk add --no-cache curl

USER spring:spring
WORKDIR ${APP_HOME}

COPY --from=build /workspace/ph-shoes-alerts-service-scheduler-web/target/*.jar app.jar

EXPOSE ${PORT}
ENTRYPOINT ["java","-Dspring.profiles.active=prod","-jar","/app/app.jar"]
